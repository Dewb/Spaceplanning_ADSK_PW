<!DOCTYPE html>
<html style="overflow: hidden;">
   <head>
      <title>Project Akaba</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
      <link rel="stylesheet" type="text/css" href="stylesheets/custom-jQueryUI-theme/jquery-ui-1.8.16.custom.css">
      <link rel="stylesheet" href="lib/codemirror/codemirror.css"/>
      <link rel="stylesheet" href="lib/codemirror/theme/elegant.css">
      <link rel="stylesheet" href="lib/slickgrid/slick.grid.css"/>
      <link rel="stylesheet" href="lib/slickgrid/slick-default-theme.css"/>
      <link rel="stylesheet" type="text/css" href="stylesheets/no-theme/jquery-ui-1.10.4.custom.css">
      <link rel="stylesheet" href="lib/radar-chart/radar-chart.css">
      <link rel="stylesheet" type="text/css" href="stylesheets/main.css">
      <script src="lib/sylvester.js"></script>
      <script src="lib/underscore.js"></script>
      <script src="http://54.172.22.83:8081/script/groundhog.js"></script>
      <script src="lib/three.js"></script>
      <script src="lib/three/ThreeCSG.js"></script>
      <script src="lib/three/loaders/STLLoader.js"></script>
      <script src="lib/three/fonts/optimer_regular.typeface.js"></script>
      <script src="lib/jquery-1.11.1.js"></script>
      <script src="lib/jquery.easing.1.3.js"></script>
      <script src="lib/jquery.event.drag-2.2.js"></script> 
      <script src="lib/jquery.pulse.min.js"></script> 
      <script src="lib/jquery-ui-1.10.4.custom.min.js"></script>
      <script src="lib/jquery-ui-1.10.4.custom.js"></script>
      <script src="lib/codemirror/codemirror.js"></script>
      <script src="lib/codemirror/mode/javascript/javascript.js"></script>
      <script src="lib/slickgrid/slick.core.js" type="text/javascript" charset="utf-8"></script>
      <script src="lib/slickgrid/plugins/slick.cellrangedecorator.js"></script>
      <script src="lib/slickgrid/plugins/slick.cellrangeselector.js"></script>
      <script src="lib/slickgrid/plugins/slick.cellselectionmodel.js"></script>
      <script src="lib/slickgrid/plugins/slick.autotooltips.js"></script> 
      <script src="lib/slickgrid/slick.formatters.js"></script>
      <script src="lib/slickgrid/slick.editors.js" type="text/javascript" charset="utf-8"></script>
      <script src="lib/slickgrid/slick.grid.js" type="text/javascript" charset="utf-8"></script>
      <script src="lib/d3/d3.js"></script>
      <script src="lib/radar-chart/radar-chart.js"></script>
      <script src="lib/jquery.quicksand.js"></script>
      <script data-main="scripts/main" src="lib/require.js"></script>
   </head>
   <body>
      <div id="container"></div>
      <div id="generatorStatusDisplay"></div>
      <div id="disconnectionWarning">
        <div>LOADING...</div>
        <img src="images/cloud_notConnected.png" draggable="false" title="Cloud connection interrupted">
      </div>
      <script>
         $("#disconnectionWarning").position({ of: $(window) });
         Groundhog.connect("54.172.22.83", "8086");
      </script>

      <script id="vertexShader" type="x-shader/x-vertex">

         precision highp float;
         precision highp int;

         uniform mat4 modelViewMatrix;
         uniform mat4 projectionMatrix;
         uniform mat4 viewMatrix;
         uniform mat4 modelMatrix;

         attribute vec3 position;
         attribute vec4 color;

         varying vec4 vColor;
         varying float z;

         uniform float highlight;
         uniform float opacityScale;

         void main() {
            vColor = color;
            vColor.rgb += highlight;
            vColor.a *= opacityScale;
            gl_Position = projectionMatrix*modelViewMatrix*vec4(position, 1.0);

            vec4 z4 = modelViewMatrix*vec4(position, 1.0);
            // z = (z4.xyz/z4.w).z;
            z = z4.z;
            // z = gl_Position.z;
            // z = position.z;
            // z = (viewMatrix*vec4(position, 1.0)).z;
         }

      </script>

      <script id="fragmentShader" type="x-shader/x-fragment">

         precision highp float;
         precision highp int;

         varying vec4 vColor;
         varying float z;

         void main() {
            z; // to silence 'not read' warnings
            vec4 color = vec4(vColor);
            gl_FragColor = color;
         }

      </script>

      <script id="fragmentShaderAccumulation" type="x-shader/x-fragment">

         precision highp float;
         precision highp int;

         varying float z;
         varying vec4 vColor;

         float w(float a)
         {
            // eq. 10
            // return a * max( 1e-2, 3.0 * 1e3 * pow( 1.0 - gl_FragCoord.z, 3.0 ) );
            // eq. 9
            //return a * clamp( 0.03 / ( 1e-5 + pow( abs( z ) / 200.0, 4.0 ) ), 1e-2, 3e3 );

            // weight function design
            // float colorResistance = 1.0; // 1.0
            // float rangeAdjustmentsClampBounds = 0.3; // 0.3
            // float depth = abs( 1.0 - gl_FragCoord.z ); // abs( z )
            // float orderingDiscrimination = 0.1; // 200.0
            // float orderingStrength = 4.0; // 4.0
            // float minValue = 1e-2;
            // float maxValue = 3e3;
            // return pow( a, colorResistance ) * 
            //     clamp( 
            //         rangeAdjustmentsClampBounds / 
            //             ( 1e-5 + pow( depth / orderingDiscrimination, orderingStrength ) ),
            //         minValue, maxValue 
            //     );

            float z2 = z;
            z2 = gl_FragCoord.z;
            z2 = 12.0; // Slightly lighter than the above line, 0.0 -> 1.0 give ~same as above line 

            // eq. 7
            return pow(a, 1.0)*clamp(10.0/(1e-5 + pow(abs(z2)/5.0, 1.0) + pow(abs(z2)/200.0, 1.0)), 1e-2, 3e3);
         }

         void main()
         {
            z; // to silence 'not read' warnings
            float ai = vColor.a;
            vec3 Ci = vColor.rgb * ai;
            gl_FragColor = vec4(Ci, ai) * w(ai);
         }

      </script>

      <script id="fragmentShaderRevealage" type="x-shader/x-fragment">

         precision highp float;
         precision highp int;

         varying float z;
         varying vec4 vColor;

         float w(float a)
         {
            // eq. 10
            // return a * max( 1e-2, 3.0 * 1e3 * pow( 1.0 - gl_FragCoord.z, 3.0 ) );
            // eq. 9
            //return a * clamp( 0.03 / ( 1e-5 + pow( abs( z ) / 200.0, 4.0 ) ), 1e-2, 3e3 );

            // weight function design
            // float colorResistance = 1.0; // 1.0
            // float rangeAdjustmentsClampBounds = 0.3; // 0.3
            // float depth = abs( 1.0 - gl_FragCoord.z ); // abs( z )
            // float orderingDiscrimination = 0.1; // 200.0
            // float orderingStrength = 4.0; // 4.0
            // float minValue = 1e-2;
            // float maxValue = 3e3;
            // return pow( a, colorResistance ) * 
            //     clamp( 
            //         rangeAdjustmentsClampBounds / 
            //             ( 1e-5 + pow( depth / orderingDiscrimination, orderingStrength ) ),
            //         minValue, maxValue 
            //     );

            float z2 = z;
            //z2 = gl_FragCoord.z;

            // eq. 7
            return pow(a, 1.0)*clamp(10.0/(1e-5 + pow(abs(z2)/5.0, 1.0) + pow(abs(z2)/200.0, 1.0)), 1e-2, 3e3);
         }

         void main()
         {
            z; // to silence 'not read' warnings
            float ai = vColor.a;
            gl_FragColor = vec4(vec3(w(ai)), 1.0);
         }

      </script>

      <script id="vertexShaderQuad" type="x-shader/x-vertex">

         varying vec2 vUv;

         void main() {
            vUv = uv;
            gl_Position = projectionMatrix*modelViewMatrix*vec4(position, 1.0);
         }

      </script>

      <script id="fragmentShaderOITCompositing" type="x-shader/x-fragment">

         varying vec2 vUv;

         uniform float offscreen;
         uniform sampler2D tAccumulation;
         uniform sampler2D tRevealage;

         void main()
         {
            vec4 accum = texture2D(tAccumulation, vUv);
            float r = texture2D(tRevealage, vUv).r;
            if (offscreen == 1.0) {
               r = (r > 0.5) ? 0.0 : 1.0;
            }

            gl_FragColor = vec4(accum.rgb/clamp(accum.a, 1e-9, 5e9), r);
         }

      </script>

      <script id="fragmentShaderShadingCompositing" type="x-shader/x-fragment">

         varying vec2 vUv;

         uniform sampler2D tShading;

         void main()
         {
            // float alpha = 1.0 - texture2D(tShading, vUv).r;
            // gl_FragColor = vec4(alpha, 1.0, 0.0, 0.0); //alpha);

            vec4 color = texture2D(tShading, vUv);
            gl_FragColor = vec4(color.r, color.r, color.r, 0.5);
         }

      </script>

   </body>
</html>
